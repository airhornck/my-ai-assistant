# 架构与对话流程设计

## 一、设计目标

1. **友好交互**：自然、亲切的对话体验
2. **意图识别**：无营销意图时保持闲聊；有营销创作意图时友好引导
3. **引导收集**：当用户有营销创作想法时，友好引导开启，收集基本信息（品牌、产品、主题）
4. **策略脑泛化**：类似 DeepSeek 深度思考，根据会话意图规划从分析到执行的思维链，不专为营销服务
5. **分析脑模块化**：营销模块（热点榜单、竞品分析等）+ 分析如何回答问题的通用模块
6. **生成脑扩展**：文本 + 未来图片、视频等
7. **汇总与回答**：最终输出符合用户会话意图，有效回答

---

## 二、当前流程

```
用户输入 → 意图识别 → 自动路由
    ├─ casual_chat → 闲聊回复（多轮，保存 InteractionHistory）
    ├─ needs_clarification → 友好引导（补充基础信息 或 平台/篇幅）
    └─ 创作意图 → MetaWorkflow
        ├─ planning_node（策略脑）：规划思维链
        ├─ orchestration_node：web_search | memory_query | analyze | generate | evaluate | 自定义插件
        └─ compilation_node：汇总报告
```

---

## 三、意图识别规则

| 意图 | 触发条件 |
|------|----------|
| casual_chat | 问候、感谢、闲聊、问功能；**不含**推广/营销/品牌/产品等词 |
| free_discussion | 营销想法但未完全结构化，如「推广华为手机」「帮我写文案」 |
| structured_request | 已给出品牌、产品、话题等结构化信息 |
| document_query | 明确以文档为主体（如「根据文档总结」） |
| command | 以 / 开头的命令 |

**硬性修正**：若用户输入含「推广」「营销」「文案」「品牌」「产品」等词，或提及具体产品（如「华为手机」），**绝不**判为 casual_chat。

---

## 四、策略脑（规划层）

- **定位**：通用深度思考能力，根据会话意图规划思维链
- **思维链**：分析对话意图 + 用户画像 + 历史 + 上下文 → 规划回答逻辑 → 输出回答
- **可用步骤**：web_search、memory_query、analyze、generate、evaluate
- **analyze**：营销场景 = 品牌与热点关联；通用场景 = 分析如何回答问题
- **generate**：当前为文案/脚本；未来可扩展图片、视频

---

## 五、分析脑（模块化）

| 模块 | 职责 | 状态 |
|------|------|------|
| 营销模块 | 品牌与热点关联、竞品分析、热点榜单 | 品牌热点已实现；竞品/热点待扩展 |
| 通用分析 | 分析如何回答问题、提取关键信息 | 待扩展 |

---

## 六、生成脑（扩展规划）

| 类型 | 状态 |
|------|------|
| 文本（文案、脚本） | 已实现 |
| 图片 | 规划中 |
| 视频 | 规划中 |

---

## 七、闲聊 vs 创作（已统一路由）

| 维度 | 闲聊 | 创作 |
|------|------|------|
| 记忆 | 不读取 | ✅ memory_query 步骤 |
| InteractionHistory | ✅ 保存 | ✅ 保存 |
| 策略脑 | 无 | ✅ 按意图规划思维链 |
| 分析脑 | 无 | ✅ 按规划调用 |
| 生成脑 | 单轮 LLM | ✅ 按规划调用 |
| 思考过程 | 无 | ✅ 思维链叙述 |
| tags 沉淀 | ✅ 生成成功后 | ✅ 成功后 |

---

## 八、对话示例（预期）

**Chat 模式**
- 问：你好 → 答：你好！很高兴见到你…
- 问：推广华为手机 → 答：好的，我来帮您！为了更好地开展营销创作，请补充：品牌、产品描述或推广主题（如「推广华为手机，目标18-35岁人群」）。
- 问：推广华为手机，年龄18-35岁 → 答：（生成推广内容 或 补充平台/篇幅）

**Deep 模式**
- 问：你好 → 答：你好！…
- 问：推广华为手机，年龄18-35岁 → 答：深度思考报告 + 思维链 + 最终输出（分析→生成→评估）
