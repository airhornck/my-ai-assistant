# 以「脑 + 插件」承载 IP/活动/知识库的架构调整分析

## 一、你的调整要点（再述）

1. **IP 打造、IP 诊断、IP 方案、活动策划方案、营销方法、知识库** 等能力，均放在 **分析脑** 或 **生成脑** 中，以 **插件方式** 实现。
2. **规划脑** 基于对用户的 **意图识别**，合理规划 **各脑的插件**（即规划「这次要跑哪些分析插件、哪些生成插件」）；其输出**同时**包含：**步骤**（供前端展示思考过程、保证用户体验）和 **分析/生成插件列表**（供编排层执行），步骤与插件列表由同一意图推导得出。
3. **数据闭环** 等作为 **独立模块**，可单独开发与维护，用于 **支撑相关插件的实现**（如反馈/回流供打分、案例沉淀等）。

---

## 二、调整是否合理：结论

**结论：合理，且与现有「脑 + 插件」架构一致，有利于扩展和维护。**

下面分「与现有架构的契合」「职责边界」「需要落地的设计点」三部分说明。

---

## 三、与现有架构的契合

### 3.1 现有基础

- **分析脑**（`domain/content/analyzer.py`）已有 **BrainPluginCenter**，当前已挂载 `bilibili_hotspot` 等插件；插件通过 `get_output(plugin_name, context)` 产出结果，编排层或分析脑可合并进「分析结果」。
- **生成脑**（`domain/content/generator.py`）目前按 `output_type`（text/image/video）路由到 TextGenerator 等，**尚未**暴露「生成脑级插件中心」；若把活动策划、IP 方案、文案等做成生成侧插件，需要在这里增加插件机制或等价扩展。
- **规划脑**（`workflows/meta_workflow.py` 的 planning_node）当前输出的是 **步骤序列**（如 web_search、memory_query、kb_retrieve、analyze、generate、evaluate），编排层按步骤名分支执行。

你的调整本质是：

- 把「做什么」从 **步骤名** 收敛为 **各脑要跑的插件名**；
- 规划脑根据 **意图** 只决定「用哪些分析插件、用哪些生成插件」；
- 分析脑/生成脑内部按「本轮规划的插件列表」执行对应插件，插件内部再调用知识库、方法论、案例、数据闭环等 **独立模块**。

这与现有「脑级插件中心」的设计是一致的；规划脑输出需**同时**支持「步骤」（前端思考过程展示）与「插件列表」（编排执行），见下节。

### 3.2 职责边界（插件 vs 独立模块）

你强调的「数据闭环等作为独立模块、可维护、支持插件」与「IP/活动/知识库等内容放在分析脑或生成脑作为插件」可以清晰拆开：

| 类型 | 含义 | 归属 | 举例 |
|------|------|------|------|
| **独立模块** | 数据、存储、通用服务，与「脑」解耦，可单独开发/部署/维护 | 不挂在某个脑下，被插件或编排层调用 | 数据闭环（反馈/回流）、知识库检索服务、营销方法论管理、案例模板与打分 |
| **脑内插件** | 某脑的一种「能力」：读上下文、调独立模块、产出结构化结果 | 分析脑 / 生成脑（及未来的评估脑等） | 知识库检索插件、IP 诊断插件、活动策划插件、营销方法论注入插件、IP 打造方案插件、文案生成插件 |

这样：

- **知识库**：  
  - **独立模块** = 检索服务（如 KnowledgePort、RetrievalService、阿里云知识库对接）；  
  - **分析脑插件** = 如「kb_retrieve」插件：在分析阶段按 query 调知识库模块，把检索结果写入 context/分析结果，供后续生成使用。
- **营销方法**：  
  - **独立模块** = 方法论的存储与管理（如 MethodologyService、knowledge/ 目录）；  
  - **分析脑插件** = 如「methodology_inject」插件：按行业/目标调方法论模块，把片段注入上下文。
- **活动策划方案 / IP 方案 / IP 诊断**：  
  - 作为 **分析脑或生成脑的插件** 实现（例如：IP 诊断 → 分析脑插件产出「诊断报告」结构；IP 打造方案、活动策划方案 → 生成脑插件产出「方案」正文）；  
  - 这些插件内部调用 **知识库、方法论、案例模板、数据闭环** 等独立模块。
- **数据闭环**：  
  - 始终是 **独立模块**（反馈事件、平台回流、案例打分等）；  
  - 可由「保存为案例」插件、打分插件、或后续的评估/优化类插件调用，用于支撑插件逻辑，而不是挂在某个脑的「内部实现」里。

因此：**「内容放在分析脑或生成脑作为插件」指的是能力/行为归属；「数据闭环等作为独立模块」指的是数据与通用服务的归属。** 两者不冲突，你的划分是合理的。

---

## 四、这样做的优点

1. **扩展点统一**  
   新增一种能力（如新的 IP 诊断维度、新的活动类型）只需新增/扩展一个脑插件，并在规划脑的意图→插件映射里挂上即可，无需在编排层堆砌新步骤分支。

2. **规划脑职责单一**  
   规划脑只做「意图 → 本轮要用的分析插件 + 生成插件」，不关心插件内部是否调知识库、方法论、案例；插件组合由意图与配置决定，易于迭代策略。

3. **独立模块可维护**  
   数据闭环、知识库、方法论、案例模板保持独立，版本、部署、测试都可单独进行；插件只依赖这些模块的接口，便于替换实现（如知识库从本地向量切到阿里云）。

4. **与现有插件体系一致**  
   分析脑已有 BrainPluginCenter 与 bilibili_hotspot 等插件，把 kb_retrieve、IP 诊断、活动分析、方法论注入等收拢为分析脑插件；把活动策划方案、IP 打造方案、文案等收拢为生成脑插件，是同一套模式的延伸。

---

## 五、需要落地的设计点

### 5.1 规划脑输出形态（步骤 + 插件列表，兼顾思考过程体验）

规划脑输出应**同时**包含两类内容，各司其职：

| 输出项 | 用途 | 说明 |
|--------|------|------|
| **步骤（plan / steps）** | **前端思考过程展示** | 用户可见的「思考过程」体验：如「已规划：网络检索 → 知识库检索 → 分析 → 生成活动方案 → 评估」。步骤名或 reason 需对用户友好，便于前端按顺序展示，形成连贯的思考叙事。 |
| **分析插件列表（analysis_plugins）** | **编排执行** | 由意图选出的、本轮要执行的分析脑插件名列表，如 `["kb_retrieve", "ip_diagnosis", "methodology_inject"]`。编排层调分析脑时传入，分析脑只执行这些插件并合并结果。 |
| **生成插件列表（generation_plugins）** | **编排执行** | 由意图选出的、本轮要执行的生成脑插件名列表，如 `["campaign_plan", "copy_writer"]`。编排层调生成脑时传入，生成脑只执行这些插件并产出内容。 |

**设计要点：**

- **步骤不取消**：步骤序列保留，用于 `thinking_logs`、前端「思考过程」展示；步骤可与插件对应（如步骤「知识库检索」对应分析插件 kb_retrieve），也可在步骤中保留对用户更易读的表述（如「检索行业知识与案例」）。
- **插件列表由意图生成**：规划脑在生成步骤的同时，根据意图解析出本轮应启用的分析插件、生成插件，写入 `analysis_plugins`、`generation_plugins`，供编排层使用。
- **前端只消费步骤**：前端展示思考过程时，仅使用步骤（及每步的 reason/thought），无需展示原始插件列表；用户体验仍是「先做了什么、再做了什么」的思考叙事。

**示例（规划脑输出结构）：**

```json
{
  "plan": [
    {"step": "web_search", "params": {"query": "..."}, "reason": "检索市场与竞品信息"},
    {"step": "memory_query", "params": {}, "reason": "查询用户偏好与品牌事实"},
    {"step": "analyze", "params": {}, "reason": "知识库检索与 IP 诊断分析"},
    {"step": "generate", "params": {"platform": "活动方案"}, "reason": "生成完整活动策划方案"},
    {"step": "evaluate", "params": {}, "reason": "评估方案质量"}
  ],
  "analysis_plugins": ["kb_retrieve", "methodology_inject", "ip_diagnosis"],
  "generation_plugins": ["campaign_plan"]
}
```

编排层：按 `plan` 执行 web_search、memory_query 等步骤；执行到 `analyze` 时调用分析脑并传入 `analysis_plugins`；执行到 `generate` 时调用生成脑并传入 `generation_plugins`；汇总时仍可用 `plan` + 各步结果生成 `thinking_logs` 供前端展示。

---

2. **分析脑**  
   - 已具备插件中心；需约定：当编排传入「本轮分析插件列表」时，只执行这些插件（并可按顺序或并行），将各插件的输出合并进统一的「分析结果」结构（如 `analysis` 下的子键 per 插件），供生成脑使用。

3. **生成脑**  
   - 当前无插件中心，只有 output_type 路由。要支持「活动策划方案」「IP 打造方案」「文案」等插件化，有两种路径：  
     - **A**：在生成脑上增加 **BrainPluginCenter**，每个「生成类型」对应一个插件（如 campaign_plan、ip_building_plan、copy_writer），由规划脑指定本轮 `generation_plugins`，生成脑按列表调用插件并合并/选择输出。  
     - **B**：保留现有 TextGenerator 等，但在其上层增加「生成策略层」：根据规划脑下发的生成插件名，路由到不同子流程（如活动策划走 strategy_orchestrator 能力、IP 方案走 IP 方案子流程），子流程内部再调知识库/方法论/案例等模块。  
   - 从长期统一扩展方式看，**A（生成脑也插件化）** 更符合你「均作为插件方式实现」的表述。

4. **知识库/营销方法在插件中的角色**  
   - **知识库**：独立模块（检索 API）；分析脑的「kb_retrieve」插件调用该模块，把检索结果写入 context/分析结果。  
   - **营销方法**：独立模块（存储/管理）；分析脑的「methodology_inject」插件（或类似名称）调用该模块，把方法论片段注入上下文。  
   - 这样「内容」以插件形式出现在脑内，「数据与服务」仍以独立模块形式存在，符合你的目标。

5. **数据闭环**  
   - 保持独立模块；与「保存为案例」、打分、反馈回流等相关的逻辑，可以放在 **评估脑插件** 或 **专门的数据闭环消费服务** 中，由编排层在合适时机调用，或由插件在生成/评估完成后异步调用。不改变「数据闭环独立、支撑插件」的定位。

---

## 六、小结

- **你的调整是合理的**：  
  - IP 打造、IP 诊断、IP 方案、活动策划方案、营销方法、知识库等以 **分析脑/生成脑插件** 的形式存在；  
  - 规划脑基于 **意图** 规划 **各脑的插件**；  
  - 数据闭环等作为 **独立模块** 可维护，并 **支撑** 这些插件。

- **与现有架构一致**：  
  - 分析脑已有插件中心，只需约定「按规划脑下发的分析插件列表执行」；  
  - 生成脑需要引入插件机制或等价策略层，以便「活动策划 / IP 方案 / 文案」等都作为插件或插件式能力挂载。

- **建议落地顺序**：  
  1. 明确规划脑输出：**步骤**（供前端思考过程展示）+ **analysis_plugins / generation_plugins**（供编排执行）；  
  2. 编排层按步骤执行，并在执行 analyze/generate 时传入对应插件列表；  
  3. 分析脑/生成脑支持「按列表执行插件」并合并结果；  
  4. 将 kb_retrieve、方法论注入、IP 诊断等收拢为分析脑插件，活动策划、IP 打造方案、文案等收拢为生成脑插件；  
  5. 数据闭环、知识库、方法论、案例模板保持独立模块，仅被插件或编排层调用。

按上述方式落地后，即可在「脑 + 插件」的单一扩展模型下，实现「根据用户意图规划各脑插件，由插件调用独立模块」的架构目标。
